#!/bin/bash

# Pomme.app launcher script
# Opens Kitty (preferred) or Terminal.app with the bundled pomme binary
# Kitty supports native float-on-top via Cmd+Ctrl+T

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
RESOURCES_DIR="$(dirname "$SCRIPT_DIR")/Resources"
POMME_BIN="$RESOURCES_DIR/pomme"

# Check if pomme binary exists
if [ ! -x "$POMME_BIN" ]; then
    osascript -e 'display alert "Pomme Error" message "The pomme binary was not found in the app bundle." as critical'
    exit 1
fi

# Window dimensions
WIN_WIDTH=420
WIN_HEIGHT=380

# Try Kitty first (supports native float-on-top)
if [ -d "/Applications/kitty.app" ]; then
    /Applications/kitty.app/Contents/MacOS/kitty \
        --title "ðŸ… Pomme" \
        --override initial_window_width=${WIN_WIDTH} \
        --override initial_window_height=${WIN_HEIGHT} \
        --override remember_window_size=no \
        --override macos_quit_when_last_window_closed=yes \
        --override confirm_os_window_close=0 \
        --override macos_window_float=yes \
        --single-instance \
        --instance-group pomme \
        "$POMME_BIN"
    exit 0
fi

# Fallback to Terminal.app
TEMP_SCRIPT=$(mktemp /tmp/pomme_launcher.XXXXXX)
cat > "$TEMP_SCRIPT" << EOF
#!/bin/bash
clear
"$POMME_BIN"
if [ \$? -ne 0 ]; then
    echo "Press any key to close..."
    read -n 1
fi
EOF
chmod +x "$TEMP_SCRIPT"

osascript << EOF
tell application "Terminal"
    activate
    set newWindow to do script "$TEMP_SCRIPT; rm -f $TEMP_SCRIPT"
    try
        set current settings of newWindow to settings set "Basic"
    end try
    delay 0.3
    set bounds of front window to {900, 50, 1300, 400}
    set custom title of front window to "ðŸ… Pomme"
end tell
EOF
